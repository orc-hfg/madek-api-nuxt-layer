name: Quality Assurance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent parallel CI runs for the same PR to save resources
# and avoid conflicts during testing
concurrency:
  group: qa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-assurance:
    name: Quality Assurance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Skip if release commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"chore: release "* ]]; then
            echo "Skipping Quality Assurance workflow for release commit"
            exit 78  # Neutral exit code that marks workflow as skipped
          fi
          echo "Not a release commit, continuing with Quality Assurance"

      - name: Setup Node.js + npm cache
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Prepare Nuxt environment
        run: npm run dev:prepare

      - name: Run linting
        run: npm run lint

      - name: Type check
        run: npm run check:types

      - name: Check for unused code & dependencies
        run: npm run check:unused

      - name: Run unit tests
        run: npm run test

      - name: Build application
        run: npm run build

      - name: Verify package can be packed
        run: |
          # Test that the package can be properly packed for publishing
          # This catches issues with .npmignore, package.json files array, etc.
          npm pack --dry-run
          echo "Package packing verification passed"
