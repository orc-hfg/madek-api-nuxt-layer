name: Quality Assurance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent parallel CI runs for the same PR to save resources
# and avoid conflicts during testing
concurrency:
  group: qa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-assurance:
    name: Quality Assurance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if release commit
        id: check_release
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"chore: release "* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "This is a release commit - Quality Assurance will be skipped"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "Not a release commit - continuing with Quality Assurance"
          fi

      - name: Setup Node.js + npm cache
        if: steps.check_release.outputs.should_skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm ci

      - name: Prepare Nuxt environment
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run dev:prepare

      - name: Run linting
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run lint

      - name: Type check
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run check:types

      - name: Check for unused code & dependencies
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run check:unused

      - name: Run unit tests
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run test

      - name: Build application
        if: steps.check_release.outputs.should_skip == 'false'
        run: npm run build

      - name: Verify package can be packed
        if: steps.check_release.outputs.should_skip == 'false'
        run: |
          # Test that the package can be properly packed for publishing
          # This catches issues with .npmignore, package.json files array, etc.
          npm pack --dry-run
          echo "Package packing verification passed"
